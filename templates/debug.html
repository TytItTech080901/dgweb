<!DOCTYPE html>
<html>
<head>
    <title>å§¿åŠ¿ä¸æƒ…ç»ªåˆ†æç³»ç»Ÿ - è°ƒè¯•é¡µé¢</title>
    <!-- å¼•å…¥å¤–éƒ¨CSSæ–‡ä»¶ -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/serial_style.css">
    <link rel="stylesheet" href="/static/css/fps_control.css">
    <!-- ä¿ç•™éƒ¨åˆ†å†…è”æ ·å¼ä»¥ç¡®ä¿å…¼å®¹æ€§ -->
    <style>
        /* ä¿ç•™ä¸€äº›åŸå§‹å†…è”æ ·å¼ */
        .auto-update {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            margin-left: 10px;
            cursor: pointer;
        }
        .auto-update.disabled {
            background-color: #ccc;
        }
        .frame-data-card {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .frame-data-title {
            font-weight: bold;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .frame-value {
            font-family: monospace;
            margin: 5px 0;
        }
        .timestamp {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
        }
        .command-history-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .command-history-item:hover {
            background-color: #f0f0f0;
        }
        .status-running {
            color: green;
            font-weight: bold;
        }
        .status-stopped {
            color: red;
            font-weight: bold;
        }
        .status-connected {
            color: green;
            font-weight: bold;
        }
        .status-disconnected {
            color: red;
            font-weight: bold;
        }
        
        /* æ·»åŠ è¿”å›æŒ‰é’®æ ·å¼ */
        .btn-return {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ea4335;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .btn-return:hover {
            background-color: #c62828;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .debug-header {
            position: relative;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }
        .nav-links {
            display: flex;
            gap: 15px;
        }
        .nav-links a {
            text-decoration: none;
            color: #2196F3;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .nav-links a:hover {
            background-color: #e3f2fd;
        }
        .config-panel {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .config-item {
            flex: 1;
            min-width: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .config-item h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .control-panel {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .control-panel-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
            color: #444;
        }
        .video-streams {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .video-stream {
            flex: 1;
            min-width: 320px;
        }
        .video-stream h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        video, img {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        button.green {
            background-color: #4CAF50;
            color: white;
        }
        button.red {
            background-color: #F44336;
            color: white;
        }
        button.btn-primary {
            background-color: #2196F3;
            color: white;
        }
        button:hover {
            opacity: 0.9;
        }
        .status-running {
            color: #4CAF50;
            font-weight: bold;
        }
        .status-stopped {
            color: #F44336;
            font-weight: bold;
        }
        .fps-setting {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .fps-setting input {
            width: 60px;
            padding: 5px;
        }
        .resolution-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .resolution-option {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background-color: #f5f5f5;
        }
        .resolution-option.active {
            background-color: #e3f2fd;
            border-color: #2196F3;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="debug-header">
            <h1>å§¿åŠ¿ä¸æƒ…ç»ªåˆ†æç³»ç»Ÿ - è°ƒè¯•é¡µé¢</h1>
            <button onclick="goToMainPage()" class="btn-return">è¿”å›ä¸»é¡µé¢</button>
        </div>
        
        <div class="tab-container">
            <div class="tab active" data-tab="analysisTab">å§¿åŠ¿ä¸æƒ…ç»ªåˆ†æ</div>
            <div class="tab" data-tab="serialTab">ä¸²å£é€šä¿¡</div>
        </div>
        
        <!-- å§¿åŠ¿åˆ†ææ ‡ç­¾é¡µ -->
        <div id="analysisTab" class="tab-content active">
            <div class="control-panel">
                <div id="analysisControls">
                    <button id="startAnalysisBtn">å¯åŠ¨åˆ†æç³»ç»Ÿ</button>
                    <button id="stopAnalysisBtn" class="red">åœæ­¢åˆ†æç³»ç»Ÿ</button>
                </div>
                <div id="analysisStatus">
                    ç³»ç»ŸçŠ¶æ€: <span id="systemStatusText">æœªåˆå§‹åŒ–</span>
                </div>
            </div>
            
            <!-- æ·»åŠ è§†é¢‘æµæ§åˆ¶ -->
            <div class="control-panel" style="margin-top: 10px;">
                <div class="control-panel-title">è§†é¢‘æµæ§åˆ¶</div>
                <div style="display: flex; align-items: center; margin-top: 10px;">
                    <div style="margin-right: 15px;">
                        è§†é¢‘æµä¼ è¾“çŠ¶æ€: <span id="streamingStatusText" class="status-stopped">å·²ç¦ç”¨</span>
                    </div>
                    <button id="toggleStreamingBtn" class="btn-primary">å¯ç”¨è§†é¢‘æµ</button>
                </div>
                <div style="margin-top: 5px; font-size: 0.9em; color: #666;">
                    æ³¨æ„: ç¦ç”¨è§†é¢‘æµå¯ä»¥å‡å°‘ç³»ç»Ÿèµ„æºå ç”¨ï¼Œä»ç„¶æ˜¾ç¤ºå¤´éƒ¨è§’åº¦å’Œæƒ…ç»ªçŠ¶æ€
                </div>
            </div>

            <!-- å¸§ç‡ä¸åˆ†è¾¨ç‡æ§åˆ¶ -->
            <div class="control-panel-fps">
                <div class="control-panel-title">å¸§ç‡ä¸åˆ†è¾¨ç‡æ§åˆ¶</div>
                
                <!-- å¸§ç‡æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="fps-container">
                    <div class="fps-box">
                        <div class="fps-title">å›¾åƒæ¥æ”¶å¸§ç‡</div>
                        <div id="captureFPS" class="fps-value">0.0</div>
                        <div class="fps-label">FPS</div>
                    </div>
                    <div class="fps-box">
                        <div class="fps-title">å›¾åƒå¤„ç†å¸§ç‡</div>
                        <div id="processFPS" class="fps-value">0.0</div>
                        <div class="fps-label">FPS</div>
                    </div>
                    <div class="fps-box">
                        <div class="fps-title">è§†é¢‘æµå¸§ç‡</div>
                        <div id="streamFPS" class="fps-value">0.0</div>
                        <div class="fps-label">FPS</div>
                    </div>
                </div>
                
                <!-- åˆ†è¾¨ç‡æ§åˆ¶åŒºåŸŸ -->
                <div class="resolution-control">
                    <div class="resolution-row">
                        <div class="resolution-label">
                            <input type="checkbox" id="adaptiveResolution" checked>
                            <label for="adaptiveResolution">è‡ªé€‚åº”åˆ†è¾¨ç‡</label>
                        </div>
                        <div class="resolution-input">
                            <select id="resolutionSelector" disabled>
                                <option value="0">é«˜åˆ†è¾¨ç‡ (640x480å¤„ç†)</option>
                                <option value="1" selected>ä¸­åˆ†è¾¨ç‡ (480x360å¤„ç†)</option>
                                <option value="2">ä½åˆ†è¾¨ç‡ (320x240å¤„ç†)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="resolution-row">
                        <div class="resolution-label">åº”ç”¨ç›®æ ‡:</div>
                        <div class="resolution-input">
                            <select id="targetSelector">
                                <option value="both" selected>å¤„ç†å’Œæµä¼ è¾“</option>
                                <option value="processing">ä»…å¤„ç†</option>
                                <option value="streaming">ä»…æµä¼ è¾“</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="resolution-row">
                        <div class="resolution-label">JPEGè´¨é‡:</div>
                        <div class="resolution-input" style="display:flex;align-items:center;">
                            <input type="range" id="qualitySlider" class="quality-slider" min="50" max="100" value="90">
                            <span id="qualityValue">90</span>%
                        </div>
                    </div>
                    
                    <button id="applyResolutionBtn" class="apply-button">åº”ç”¨è®¾ç½®</button>
                </div>
            </div>
            
            <!-- æ·»åŠ åå§¿æ—¶é—´å æ¯”ç»Ÿè®¡å¡ç‰‡ -->
            <div class="control-panel">
                <div class="control-panel-title">åå§¿æ—¶é—´å æ¯”ç»Ÿè®¡</div>
                
                <div class="time-range-selector">
                    <button class="time-range-btn active" data-range="day">ä»Šæ—¥</button>
                    <button class="time-range-btn" data-range="week">æœ¬å‘¨</button>
                    <button class="time-range-btn" data-range="month">æœ¬æœˆ</button>
                </div>
                
                <div class="posture-stats-container">
                    <div class="posture-summary">
                        <div class="total-time-display">
                            ç›‘æµ‹æ€»æ—¶é•¿: <span id="totalPostureTime">0h 0m</span>
                        </div>
                        <div class="good-posture-percentage">
                            è‰¯å¥½åå§¿å æ¯”: <span id="goodPosturePercentage">0%</span>
                        </div>
                    </div>
                    
                    <div class="posture-types-container">
                        <div class="posture-type-card good">
                            <div class="posture-type-title">è‰¯å¥½åå§¿</div>
                            <div class="posture-type-percentage" id="goodPercentage">0%</div>
                            <div class="posture-type-time" id="goodTime">0h 0m</div>
                            <div class="posture-type-desc">0-30Â°</div>
                        </div>
                        <div class="posture-type-card mild">
                            <div class="posture-type-title">è½»åº¦ä¸è‰¯</div>
                            <div class="posture-type-percentage" id="mildPercentage">0%</div>
                            <div class="posture-type-time" id="mildTime">0h 0m</div>
                            <div class="posture-type-desc">30-45Â°</div>
                        </div>
                        <div class="posture-type-card moderate">
                            <div class="posture-type-title">ä¸­åº¦ä¸è‰¯</div>
                            <div class="posture-type-percentage" id="moderatePercentage">0%</div>
                            <div class="posture-type-time" id="moderateTime">0h 0m</div>
                            <div class="posture-type-desc">45-60Â°</div>
                        </div>
                        <div class="posture-type-card severe">
                            <div class="posture-type-title">ä¸¥é‡ä¸è‰¯</div>
                            <div class="posture-type-percentage" id="severePercentage">0%</div>
                            <div class="posture-type-time" id="severeTime">0h 0m</div>
                            <div class="posture-type-desc">60Â°ä»¥ä¸Š</div>
                        </div>
                    </div>
                </div>
                
                <div class="posture-thresholds-container">
                    <h4>åå§¿åˆ†ç±»é˜ˆå€¼è®¾ç½®</h4>
                    <div class="threshold-controls">
                        <div class="threshold-item">
                            <label>è‰¯å¥½åå§¿ä¸Šé™(Â°):</label>
                            <input type="number" id="goodThreshold" min="10" max="40" step="1" value="30">
                        </div>
                        <div class="threshold-item">
                            <label>è½»åº¦ä¸è‰¯ä¸Šé™(Â°):</label>
                            <input type="number" id="mildThreshold" min="30" max="55" step="1" value="45">
                        </div>
                        <div class="threshold-item">
                            <label>ä¸­åº¦ä¸è‰¯ä¸Šé™(Â°):</label>
                            <input type="number" id="moderateThreshold" min="45" max="70" step="1" value="60">
                        </div>
                    </div>
                    <button id="applyThresholdsBtn" class="apply-button">åº”ç”¨é˜ˆå€¼è®¾ç½®</button>
                </div>
            </div>
            
            <div class="video-container">
                <div class="video-box">
                    <div class="video-title">å§¿åŠ¿åˆ†æ</div>
                    <img id="poseVideo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=" alt="å§¿åŠ¿åˆ†æè§†é¢‘" data-src="/pose_video_feed" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII='">
                    <div class="status-container">
                        <div class="status-item">
                            <span class="status-label">å¤´éƒ¨è§’åº¦:</span>
                            <span id="headAngle" class="status-value">-- Â°</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å§¿åŠ¿çŠ¶æ€:</span>
                            <span id="postureStatus" class="status-value">--</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ£€æµ‹çŠ¶æ€:</span>
                            <span id="detectionStatus" class="status-value">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="video-box">
                    <div class="video-title">æƒ…ç»ªåˆ†æ</div>
                    <img id="emotionVideo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=" alt="æƒ…ç»ªåˆ†æè§†é¢‘" data-src="/emotion_video_feed" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII='">
                    <div class="status-container">
                        <div class="status-item">
                            <span class="status-label">å½“å‰æƒ…ç»ª:</span>
                            <span id="emotionStatus" class="status-value">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="control-box">
                <h3>æƒ…ç»ªåˆ†æå‚æ•°è°ƒæ•´</h3>
                <div class="emotion-params">
                    <!-- æ·»åŠ è§£é‡Šæ–‡æœ¬ -->
                    <div class="param-guide">
                        <p>é€šè¿‡è°ƒæ•´ä»¥ä¸‹å‚æ•°å¯ä»¥æé«˜æƒ…ç»ªæ£€æµ‹çš„ç²¾ç¡®åº¦ï¼Œé€‚åº”ä¸åŒäººç¾¤å’Œç¯å¢ƒå…‰çº¿æ¡ä»¶ã€‚åˆç†çš„å‚æ•°å¯ä»¥æ˜¾è‘—æ”¹å–„æ£€æµ‹æ•ˆæœã€‚</p>
                    </div>
                    
                    <form id="emotionParamsForm">
                        <div class="form-group">
                            <label>æƒ…ç»ªå¹³æ»‘çª—å£å¤§å° (å¸§æ•°):</label>
                            <div class="param-description">
                                <small>æ§åˆ¶æƒ…ç»ªçŠ¶æ€çš„ç¨³å®šæ€§ã€‚è¾ƒå¤§çš„å€¼ä½¿æƒ…ç»ªå˜åŒ–æ›´å¹³æ»‘ä½†å“åº”æ›´æ…¢ï¼Œè¾ƒå°çš„å€¼ä½¿å“åº”æ›´æ•æ„Ÿä½†å¯èƒ½ä¸ç¨³å®šã€‚å…‰çº¿è‰¯å¥½æ—¶æ¨è5-10ï¼Œå…‰çº¿ä¸è¶³æ—¶æ¨è7-15ã€‚</small>
                            </div>
                            <div class="range-control">
                                <input type="range" id="smoothingWindowSlider" name="emotion_smoothing_window" min="1" max="30" step="1" value="7" oninput="updateRangeValue('smoothingWindowSlider', 'smoothingWindowValue')">
                                <span id="smoothingWindowValue" class="range-value">7</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>å˜´éƒ¨å¼€åˆæ¯”é˜ˆå€¼ (ç¬‘å®¹æ£€æµ‹):</label>
                            <div class="param-description">
                                <small>åˆ¤æ–­å¾®ç¬‘çš„æ•æ„Ÿåº¦ã€‚å€¼è¶Šä½è¶Šå®¹æ˜“åˆ¤å®šä¸ºå¾®ç¬‘ï¼Œå€¼è¶Šé«˜åˆ™éœ€è¦æ›´æ˜æ˜¾çš„ç¬‘å®¹ã€‚äºšæ´²é¢å­”å»ºè®®0.35-0.45ï¼Œè¥¿æ–¹é¢å­”å»ºè®®0.4-0.5ã€‚ç¬‘å®¹æ£€æµ‹ä¸å‡†ç¡®æ—¶è°ƒæ•´æ­¤å‚æ•°ã€‚</small>
                            </div>
                            <div class="range-control">
                                <input type="range" id="mouthRatioSlider" name="mouth_open_ratio_threshold" min="0.1" max="1.0" step="0.01" value="0.45" oninput="updateRangeValue('mouthRatioSlider', 'mouthRatioValue')">
                                <span id="mouthRatioValue" class="range-value">0.45</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>çœ¼ç›å¼€åˆæ¯”é˜ˆå€¼ (é—­çœ¼æ£€æµ‹):</label>
                            <div class="param-description">
                                <small>åˆ¤æ–­çœ¼ç›é—­åˆçš„æ•æ„Ÿåº¦ã€‚å€¼è¶Šä½è¶Šå®¹æ˜“åˆ¤å®šä¸ºé—­çœ¼ï¼Œå€¼è¶Šé«˜åˆ™éœ€è¦æ›´æ˜æ˜¾çš„é—­çœ¼åŠ¨ä½œã€‚å•çœ¼çš®äººç¾¤å»ºè®®è°ƒä½è‡³0.15-0.2ï¼ŒåŒçœ¼çš®äººç¾¤å»ºè®®0.2-0.3ã€‚ç»å¸¸è¯¯åˆ¤é—­çœ¼æ—¶è°ƒæ•´æ­¤å‚æ•°ã€‚</small>
                            </div>
                            <div class="range-control">
                                <input type="range" id="eyeRatioSlider" name="eye_open_ratio_threshold" min="0.05" max="0.5" step="0.01" value="0.25" oninput="updateRangeValue('eyeRatioSlider', 'eyeRatioValue')">
                                <span id="eyeRatioValue" class="range-value">0.25</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>çœ‰æ¯›ä¸‹å‹é˜ˆå€¼ (çš±çœ‰æ£€æµ‹):</label>
                            <div class="param-description">
                                <small>åˆ¤æ–­çš±çœ‰/ç”Ÿæ°”è¡¨æƒ…çš„æ•æ„Ÿåº¦ã€‚å€¼è¶Šä½è¶Šå®¹æ˜“åˆ¤å®šä¸ºçš±çœ‰ï¼Œå€¼è¶Šé«˜åˆ™éœ€è¦æ›´æ˜æ˜¾çš„çš±çœ‰åŠ¨ä½œã€‚å®¹æ˜“è¢«è¯¯åˆ¤ä¸ºç”Ÿæ°”æ—¶ï¼Œå¯ä»¥è°ƒé«˜è‡³0.05-0.08ï¼›è¡¨æƒ…ä¸°å¯Œè€…å¯è°ƒä½è‡³0.02-0.04ã€‚</small>
                            </div>
                            <div class="range-control">
                                <input type="range" id="browThresholdSlider" name="brow_down_threshold" min="0.01" max="0.2" step="0.01" value="0.04" oninput="updateRangeValue('browThresholdSlider', 'browThresholdValue')">
                                <span id="browThresholdValue" class="range-value">0.04</span>
                            </div>
                        </div>
                    </form>
                    
                    <div class="param-tips">
                        <h4>è°ƒå‚æŠ€å·§ï¼š</h4>
                        <ul>
                            <li><strong>é€ä¸€è°ƒæ•´</strong>ï¼šä¸€æ¬¡åªè°ƒæ•´ä¸€ä¸ªå‚æ•°ï¼Œè§‚å¯Ÿæ•ˆæœåå†è°ƒæ•´ä¸‹ä¸€ä¸ª</li>
                            <li><strong>å°æ­¥è°ƒæ•´</strong>ï¼šæ¯æ¬¡åªå°å¹…è°ƒæ•´å‚æ•°å€¼ï¼ˆÂ±5-10%ï¼‰ï¼Œé¿å…å¤§å¹…å˜åŒ–</li>
                            <li><strong>æµ‹è¯•è¡¨æƒ…</strong>ï¼šè°ƒæ•´æ—¶è¯·åšå‡ºæ˜æ˜¾çš„è¡¨æƒ…ï¼ˆå¾®ç¬‘ã€çš±çœ‰ã€é—­çœ¼ç­‰ï¼‰éªŒè¯æ•ˆæœ</li>
                            <li><strong>ç¯å¢ƒå…‰çº¿</strong>ï¼šç¡®ä¿é¢éƒ¨å…‰çº¿å……è¶³ä¸”å‡åŒ€ï¼Œé¿å…ä¾§å…‰æˆ–èƒŒå…‰</li>
                            <li><strong>è®°å½•ç»“æœ</strong>ï¼šæ‰¾åˆ°æœ€ä½³å‚æ•°åè®°å½•ä¸‹æ¥ï¼Œä¸åŒä½¿ç”¨è€…å¯èƒ½éœ€è¦ä¸åŒé…ç½®</li>
                        </ul>
                    </div>
                    
                    <button onclick="saveEmotionParams()" class="apply-params-button">åº”ç”¨å‚æ•°</button>
                </div>
            </div>
        </div>
        
        <!-- ä¸²å£é€šä¿¡æ ‡ç­¾é¡µ -->
        <div id="serialTab" class="tab-content">
            <!-- ä¸²å£è¿æ¥æ§åˆ¶ -->
            <div class="control-panel">
                <div>
                    <input type="text" id="portInput" placeholder="/dev/ttyUSB0" value="/dev/ttyUSB0" style="margin: 0 10px; padding: 8px;">
                    <select id="baudrateSelect">
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200" selected>115200</option>
                    </select>
                    <button id="connectBtn">è¿æ¥</button>
                    <button id="disconnectBtn" class="red">æ–­å¼€</button>
                </div>
                <div>
                    çŠ¶æ€: <span id="serialStatusText" class="status-disconnected">æœªè¿æ¥</span>
                </div>
            </div>
            
            <!-- ä¸²å£å‘½ä»¤å‘é€ -->
            <div class="control-panel">
                <div style="display: flex; width: 100%;">
                    <input type="text" id="commandInput" placeholder="è¾“å…¥å‘½ä»¤" style="flex: 1; margin-right: 10px; padding: 8px;">
                    <button id="sendCommandBtn">å‘é€</button>
                </div>
            </div>
            
            <!-- å‘½ä»¤å†å²è®°å½• -->
            <div class="control-box">
                <h3>å‘½ä»¤å†å²</h3>
                <div id="commandHistory" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
            
            <!-- æ§åˆ¶é€‰é¡¹æ ‡ç­¾é¡µ -->
            <div class="tab-container" style="margin-top: 20px;">
                <div class="tab active" onclick="openSubTab(event, 'textMode')">æ–‡æœ¬æ¨¡å¼</div>
                <div class="tab" onclick="openSubTab(event, 'frameMode')">å¸§æ¨¡å¼</div>
                <div class="tab" onclick="openSubTab(event, 'protocolMode')">æ–°åè®®æ¨¡å¼</div>
            </div>
            
            <div id="textMode" class="tab-content active">
                <div>
                    <input type="text" id="dataInput" placeholder="è¾“å…¥è¦å‘é€çš„æ•°æ®">
                    <button onclick="sendData()">å‘é€</button>
                </div>
            </div>
            
            <div id="frameMode" class="tab-content">
                <div class="form-group">
                    <label for="yawInput">Yaw å€¼:</label>
                    <input type="number" id="yawInput" step="0.01" value="0.0">
                </div>
                
                <div class="form-group">
                    <label for="pitchInput">Pitch å€¼:</label>
                    <input type="number" id="pitchInput" step="0.01" value="0.0">
                </div>
                
                <div class="form-group">
                    <input type="checkbox" id="findBoolInput">
                    <label for="findBoolInput" style="display: inline;">æ˜¯å¦è¿½è¸ª</label>
                </div>
                
                <div>
                    <button onclick="sendFrame()">å‘é€å¸§æ•°æ®</button>
                    <button onclick="readFrame()">è¯»å–å¸§æ•°æ®</button>
                    <button id="autoUpdateBtn" onclick="toggleAutoUpdate()" class="auto-update">è‡ªåŠ¨æ›´æ–°: å¼€å¯</button>
                </div>
                
                <div id="latestFrameData" class="frame-data-card" style="display: none;">
                    <div class="frame-data-title">æœ€æ–°æ¥æ”¶çš„å¸§æ•°æ®</div>
                    <div class="frame-value">ç±»å‹: <span id="frameType"></span></div>
                    <div class="frame-value">Yaw: <span id="frameYaw"></span></div>
                    <div class="frame-value">Pitch: <span id="framePitch"></span></div>
                    <div class="timestamp" id="frameTimestamp"></div>
                </div>
            </div>
            
            <div id="protocolMode" class="tab-content">
                <!-- æ–°åè®®è°ƒè¯•é¢æ¿ -->
                <div class="control-panel-title">ğŸ”§ æ–°åè®®è°ƒè¯•å·¥å…·</div>
                
                <!-- å¿«æ·å‘½ä»¤æŒ‰é’®ç»„ -->
                <div class="command-buttons-grid">
                    <div class="command-group">
                        <h4>ğŸ”Œ ç”µæºæ§åˆ¶</h4>
                        <button onclick="sendProtocolCommand(0x00)" class="protocol-btn power">å¼€æœº</button>
                        <button onclick="sendProtocolCommand(0x01)" class="protocol-btn power">å…³æœº</button>
                        <button onclick="sendProtocolCommand(0x02)" class="protocol-btn reset">å¤ä½</button>
                    </div>
                    
                    <div class="command-group">
                        <h4>ğŸ’¡ ç¯å…‰æ§åˆ¶</h4>
                        <button onclick="sendProtocolCommand(0x14)" class="protocol-btn light-on">å¼€ç¯</button>
                        <button onclick="sendProtocolCommand(0x15)" class="protocol-btn light-off">å…³ç¯</button>
                        <button onclick="sendProtocolCommand(0x10)" class="protocol-btn brightness">äº®åº¦+</button>
                        <button onclick="sendProtocolCommand(0x11)" class="protocol-btn brightness">äº®åº¦-</button>
                        <button onclick="sendProtocolCommand(0x12)" class="protocol-btn temp">è‰²æ¸©+</button>
                        <button onclick="sendProtocolCommand(0x13)" class="protocol-btn temp">è‰²æ¸©-</button>
                    </div>
                    
                    <div class="command-group">
                        <h4>âš ï¸ æé†’åŠŸèƒ½</h4>
                        <button onclick="sendProtocolCommand(0x20)" class="protocol-btn reminder">åå§¿æé†’</button>
                        <button onclick="sendProtocolCommand(0x21)" class="protocol-btn reminder">è¿œçœºæé†’</button>
                    </div>
                </div>
                
                <!-- è‡ªå®šä¹‰å‘½ä»¤å‘é€ -->
                <div class="custom-command-section">
                    <h4>ğŸ“ è‡ªå®šä¹‰å‘½ä»¤</h4>
                    <div class="custom-command-form">
                        <div class="form-row">
                            <label>æ¶ˆæ¯ç±»å‹:</label>
                            <select id="protocolDatatype">
                                <option value="0xA0">0xA0 (ä¸Šä½æœº->ä¸‹ä½æœº)</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>å‘½ä»¤å­—:</label>
                            <input type="text" id="protocolCommand" placeholder="0x00" value="0x00">
                        </div>
                        <div class="form-row">
                            <label>æ•°æ®åŸŸ (8ä¸ªuint32å€¼):</label>
                            <div class="data-array-inputs">
                                <input type="number" id="data0" placeholder="æ•°æ®0" value="0">
                                <input type="number" id="data1" placeholder="æ•°æ®1" value="0">
                                <input type="number" id="data2" placeholder="æ•°æ®2" value="0">
                                <input type="number" id="data3" placeholder="æ•°æ®3" value="0">
                                <input type="number" id="data4" placeholder="æ•°æ®4" value="0">
                                <input type="number" id="data5" placeholder="æ•°æ®5" value="0">
                                <input type="number" id="data6" placeholder="æ•°æ®6" value="0">
                                <input type="number" id="data7" placeholder="æ•°æ®7" value="0">
                            </div>
                        </div>
                        <button onclick="sendCustomProtocolCommand()" class="protocol-btn custom">å‘é€è‡ªå®šä¹‰å‘½ä»¤</button>
                    </div>
                </div>
                
                <!-- åè®®çŠ¶æ€æ˜¾ç¤º -->
                <div class="protocol-status-section">
                    <h4>ğŸ“Š è®¾å¤‡çŠ¶æ€ (æ¥è‡ª0xB0å¸§)</h4>
                    <div class="status-display">
                        <div class="status-item">
                            <span class="status-label">è®¾å¤‡ç”µæº:</span>
                            <span id="devicePowerStatus" class="status-value">æœªçŸ¥</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ç¯å…‰çŠ¶æ€:</span>
                            <span id="deviceLightStatus" class="status-value">æœªçŸ¥</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å½“å‰äº®åº¦:</span>
                            <span id="deviceBrightness" class="status-value">æœªçŸ¥</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å½“å‰è‰²æ¸©:</span>
                            <span id="deviceColorTemp" class="status-value">æœªçŸ¥</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æœ€åæ›´æ–°:</span>
                            <span id="deviceLastUpdate" class="status-value">æœªæ›´æ–°</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <h2>å“åº”:</h2>
            <div id="response"></div>
            
            <h2>å†å²è®°å½•:</h2>
            <button class="clear-history" onclick="clearHistory()">æ¸…ç©ºå†å²è®°å½•</button>
            <div id="history"></div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>
    
    <!-- å¼•å…¥JavaScriptæ¨¡å— -->
    <script src="/static/js/main.js"></script>
    <script src="/static/js/tabs.js"></script>
    <script src="/static/js/analysis.js"></script>
    <script src="/static/js/fps_control.js"></script>
    <script src="/static/js/serial.js"></script>
    <script src="/static/js/serial_enhanced.js"></script>
    
    <!-- ä¿ç•™éƒ¨åˆ†å†…è”è„šæœ¬ä»¥ç¡®ä¿å…¼å®¹æ€§ -->
    <script>
        // é¡µé¢ç‰¹å®šå˜é‡
        let currentPage = 1;
        let totalPages = 1;
        const perPage = 10;
        let analysisStatusInterval = null;
        let autoUpdateEnabled = true;
        let eventSource = null;
        
        // è·³è½¬åˆ°ä¸»é¡µé¢å‡½æ•°
        function goToMainPage() {
            window.location.href = '/';
        }
        
        // ä»¥ä¸‹å‡½æ•°éœ€è¦ä¿ç•™ä¸ºå†…è”è„šæœ¬ä»¥ç¡®ä¿å…¼å®¹æ€§
        function updateRangeValue(sliderId, valueId) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(valueId);
            
            // é’ˆå¯¹ä¸åŒç±»å‹çš„å€¼ä½¿ç”¨ä¸åŒçš„æ ¼å¼
            if (sliderId === 'smoothingWindowSlider') {
                valueDisplay.textContent = slider.value;
            } else {
                valueDisplay.textContent = parseFloat(slider.value).toFixed(2);
            }
        }
        
        // å‘é€æ–‡æœ¬æ•°æ®
        function sendData() {
            const data = document.getElementById('dataInput').value;
            
            fetch('/api/send_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({data: data})
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('response').innerText = data.response;
                updateHistory(1);  // å‘é€åè¿”å›ç¬¬ä¸€é¡µ
            });
        }
        
        // å‘é€å¸§æ•°æ®
        function sendFrame() {
            const yaw = parseFloat(document.getElementById('yawInput').value);
            const pitch = parseFloat(document.getElementById('pitchInput').value);
            const find_bool = document.getElementById('findBoolInput').checked;
            
            fetch('/api/send_frame', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    yaw: yaw,
                    pitch: pitch,
                    find_bool: find_bool
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('response').innerText = data.response;
                updateHistory(1);  // å‘é€åè¿”å›ç¬¬ä¸€é¡µ
            });
        }
        
        // è¯»å–å¸§æ•°æ®
        function readFrame() {
            fetch('/api/read_frame')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('response').innerText = JSON.stringify(data.frame_data, null, 2);
                } else {
                    document.getElementById('response').innerText = data.message;
                }
            });
        }

        // åˆ›å»ºæ—¥æœŸæ ¼å¼åŒ–å™¨
        const dateFormatter = new Intl.DateTimeFormat(undefined, {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        
        // æ›´æ–°å†å²è®°å½•
        function updateHistory(page) {
            fetch(`/api/get_history?page=${page}&per_page=${perPage}`)
            .then(response => response.json())
            .then(data => {
                const historyDiv = document.getElementById('history');
                historyDiv.innerHTML = '';
                
                if (data.status === 'error') {
                    historyDiv.innerHTML = `<div class="error">${data.message}</div>`;
                    return;
                }
                
                if (!data.records || data.records.length === 0) {
                    historyDiv.innerHTML = '<div>æš‚æ— å†å²è®°å½•</div>';
                    return;
                }
                
                data.records.forEach(record => {
                    // Convert MySQL timestamp to local time
                    const timestamp = new Date(record.timestamp);
                    const formattedDate = dateFormatter.format(timestamp);
                    
                    historyDiv.innerHTML += `
                        <div class="history-record">
                            <span class="record-number">#${record.record_number}</span>
                            <br>
                            å‘é€: ${record.sent_data || 'æ— æ•°æ®'}<br>
                            æ¥æ”¶: ${record.received_data || 'æ— å“åº”'}<br>
                            çŠ¶æ€: ${record.status || 'æœªçŸ¥'}<br>
                            æ¶ˆæ¯: ${record.message || 'æ— æ¶ˆæ¯'}<br>
                            æ—¶é—´: ${formattedDate}
                        </div>
                    `;
                });
                
                currentPage = data.current_page;
                totalPages = data.total_pages;
                updatePagination();
            })
            .catch(error => {
                console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
                document.getElementById('history').innerHTML = '<div class="error">è·å–å†å²è®°å½•å¤±è´¥</div>';
            });
        }
        
        // æ›´æ–°åˆ†é¡µæŒ‰é’®
        function updatePagination() {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';
            
            // é¦–é¡µæŒ‰é’®
            if (currentPage > 1) {
                paginationDiv.innerHTML += `
                    <button onclick="updateHistory(1)">é¦–é¡µ</button>
                    <button onclick="updateHistory(${currentPage - 1})">ä¸Šä¸€é¡µ</button>
                `;
            }
            
            // é¡µç æ˜¾ç¤º
            paginationDiv.innerHTML += `<span>ç¬¬ ${currentPage}/${totalPages} é¡µ</span>`;
            
            // ä¸‹ä¸€é¡µå’Œæœ«é¡µæŒ‰é’®
            if (currentPage < totalPages) {
                paginationDiv.innerHTML += `
                    <button onclick="updateHistory(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>
                    <button onclick="updateHistory(${totalPages})">æœ«é¡µ</button>
                `;
            }
        }
        
        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                fetch('/api/clear_history', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('å†å²è®°å½•å·²æ¸…ç©º');
                        updateHistory(1);  // åˆ·æ–°é¡µé¢æ˜¾ç¤º
                    } else {
                        alert('æ¸…ç©ºå†å²è®°å½•å¤±è´¥: ' + data.message);
                    }
                });
            }
        }
        
        // å­æ ‡ç­¾é¡µåˆ‡æ¢
        function openSubTab(evt, tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            const tabContents = document.querySelectorAll("#serialTab .tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            const tabs = document.querySelectorAll("#serialTab .tab");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }
            
            // æ˜¾ç¤ºå½“å‰æ ‡ç­¾å¹¶æ·»åŠ activeç±»
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }
        
        // å¸§æ•°æ®è‡ªåŠ¨æ›´æ–°ç›¸å…³
        function toggleAutoUpdate() {
            autoUpdateEnabled = !autoUpdateEnabled;
            const btn = document.getElementById('autoUpdateBtn');
            
            if (autoUpdateEnabled) {
                btn.innerText = "è‡ªåŠ¨æ›´æ–°: å¼€å¯";
                btn.classList.remove('disabled');
                startEventSource();
            } else {
                btn.innerText = "è‡ªåŠ¨æ›´æ–°: å…³é—­";
                btn.classList.add('disabled');
                stopEventSource();
            }
        }
        
        // å¯åŠ¨äº‹ä»¶æº
        function startEventSource() {
            if (eventSource) {
                stopEventSource();
            }
            
            eventSource = new EventSource('/api/frame_events');
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // å¿½ç•¥å¿ƒè·³åŒ…
                if (data.type === 'heartbeat') {
                    return;
                }
                
                // å¦‚æœæœ‰é”™è¯¯
                if (data.error) {
                    console.error('SSEé”™è¯¯:', data.error);
                    return;
                }
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤ºæœ€æ–°å¸§æ•°æ®
                updateLatestFrameDisplay(data);
                
                // åˆ·æ–°å†å²è®°å½•ï¼ˆä»…æ˜¾ç¤ºç¬¬ä¸€é¡µï¼‰
                updateHistory(1);
            };
            
            eventSource.onerror = function(error) {
                console.error('SSEè¿æ¥é”™è¯¯:', error);
                // å¦‚æœè¿æ¥æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥
                setTimeout(() => {
                    if (autoUpdateEnabled) {
                        stopEventSource();
                        startEventSource();
                    }
                }, 5000);
            };
        }
        
        // åœæ­¢äº‹ä»¶æº
        function stopEventSource() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }
        
        // æ›´æ–°æœ€æ–°å¸§æ•°æ®æ˜¾ç¤º
        function updateLatestFrameDisplay(frameData) {
            const frameCard = document.getElementById('latestFrameData');
            frameCard.style.display = 'block';
            
            document.getElementById('frameType').innerText = '0x' + frameData.type.toString(16).toUpperCase();
            document.getElementById('frameYaw').innerText = frameData.yaw.toFixed(4);
            document.getElementById('framePitch').innerText = frameData.pitch.toFixed(4);
            document.getElementById('frameTimestamp').innerText = 'æ¥æ”¶æ—¶é—´: ' + new Date().toLocaleString();
        }
        
        // åœ¨é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œ
        window.addEventListener('load', function() {
            // é¡µé¢å…³é—­æˆ–åˆ·æ–°æ—¶å…³é—­äº‹ä»¶æº
            window.addEventListener('beforeunload', function() {
                stopEventSource();
                if (analysisStatusInterval) {
                    clearInterval(analysisStatusInterval);
                }
            });
        
            // å¦‚æœè‡ªåŠ¨æ›´æ–°å¼€å¯ï¼Œå¯åŠ¨äº‹ä»¶æº
            if (autoUpdateEnabled) {
                startEventSource();
            }
            
            // è·å–å†å²è®°å½•
            updateHistory(1);
        });
    </script>
</body>
</html>